<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›ä½œè€…ä¸­å¿ƒ | AI Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = { theme: { extend: { colors: { brand: '#7c3aed', dark: { bg: '#0f172a', card: '#1e293b', sidebar: '#161e2e' } } } } }
    </script>
    <style>
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-dark-bg text-gray-200 font-sans antialiased h-screen flex overflow-hidden">

    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <aside class="w-64 bg-dark-sidebar border-r border-gray-800 flex flex-col justify-between flex-shrink-0">
        <div>
            <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯ç®€ç•¥ -->
            <div class="p-6 border-b border-gray-800 flex items-center gap-3 cursor-pointer hover:bg-white/5 transition" onclick="window.location.href='index.html'">
                <i class="fa-solid fa-arrow-left text-gray-400"></i>
                <span class="font-bold text-white">è¿”å›é¦–é¡µ</span>
            </div>
            
            <!-- ä¸Šä¼ å¤§æŒ‰é’® -->
            <div class="p-4">
                <button onclick="window.location.href='upload.html'" class="w-full bg-brand hover:bg-brand-dark text-white py-3 rounded-xl font-bold shadow-lg shadow-brand/20 transition transform hover:scale-105">
                    <i class="fa-solid fa-cloud-upload-alt mr-2"></i> ä¸Šä¼ æ–°ä½œå“
                </button>
            </div>

            <!-- å¯¼èˆªèœå• -->
            <nav class="px-2 space-y-1">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" data-tab="dashboard" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white transition flex items-center gap-3 bg-brand/10 text-brand">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> ä»ªè¡¨ç›˜
                </button>
                <button onclick="switchTab('videos')" id="btn-videos" data-tab="videos" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white transition flex items-center gap-3">
                    <i class="fa-solid fa-video w-5 text-center"></i> ä½œå“ç®¡ç†
                </button>
                <button onclick="switchTab('finance')" id="btn-finance" data-tab="finance" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white transition flex items-center gap-3">
                    <i class="fa-solid fa-wallet w-5 text-center"></i> è´¢åŠ¡ä¸­å¿ƒ
                </button>
                <button onclick="switchTab('settings')" id="btn-settings" data-tab="settings" class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white transition flex items-center gap-3">
                    <i class="fa-solid fa-gear w-5 text-center"></i> è´¦å·è®¾ç½®
                </button>
            </nav>
        </div>

        <!-- åº•éƒ¨é€€å‡º -->
        <div class="p-4 border-t border-gray-800">
            <button onclick="logout()" class="w-full text-left px-4 py-2 text-red-400 hover:bg-red-500/10 rounded-lg transition flex items-center gap-3">
                <i class="fa-solid fa-right-from-bracket w-5 text-center"></i> é€€å‡ºç™»å½•
            </button>
        </div>
    </aside>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-8 relative">
        
        <!-- 1. ä»ªè¡¨ç›˜ (Dashboard) -->
        <div id="tab-dashboard" class="tab-content active">
            <h1 class="text-3xl font-bold text-white mb-6">æ¬¢è¿å›æ¥, <span id="u-name">...</span> ğŸ‘‹</h1>
            
            <!-- èµ„äº§å¡ç‰‡ (ç‚¹å‡»è·³è½¬è´¢åŠ¡) -->
            <div id="balance-card" class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 mb-8 shadow-2xl relative overflow-hidden cursor-pointer hover:scale-[1.01] transition group">
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <p class="text-indigo-200 text-sm mb-1 group-hover:text-white transition">å½“å‰ä½™é¢ (ç‚¹å‡»ç®¡ç†)</p>
                        <h2 class="text-5xl font-bold text-white flex items-center gap-2">
                            <span id="u-balance">0</span> <span class="text-2xl text-yellow-300">AIV</span>
                        </h2>
                    </div>
                    <div class="bg-white/20 p-4 rounded-full backdrop-blur-sm group-hover:bg-white/30 transition">
                        <i class="fa-solid fa-wallet text-3xl text-white"></i>
                    </div>
                </div>
                <!-- è£…é¥° -->
                <div class="absolute -right-10 -bottom-10 w-48 h-48 bg-white/10 rounded-full blur-3xl"></div>
            </div>

            <!-- æ•°æ®æ¦‚è§ˆ -->
            <div class="grid grid-cols-3 gap-6">
                <div class="bg-dark-card p-6 rounded-xl border border-gray-800">
                    <div class="text-gray-400 text-sm mb-2">æ€»æµè§ˆé‡</div>
                    <div class="text-2xl font-bold text-white">12,450</div>
                </div>
                <div class="bg-dark-card p-6 rounded-xl border border-gray-800">
                    <div class="text-gray-400 text-sm mb-2">æ€»ä¸‹è½½</div>
                    <div class="text-2xl font-bold text-brand-light">892</div>
                </div>
                <div class="bg-dark-card p-6 rounded-xl border border-gray-800">
                    <div class="text-gray-400 text-sm mb-2">ä½œå“æ•°é‡</div>
                    <div class="text-2xl font-bold text-white" id="u-video-count">0</div>
                </div>
            </div>
        </div>

        <!-- 2. ä½œå“ç®¡ç† (My Videos) -->
        <div id="tab-videos" class="tab-content">
            <h2 class="text-2xl font-bold text-white mb-6">ä½œå“ç®¡ç†</h2>
            <div class="bg-dark-card rounded-xl border border-gray-800 overflow-hidden">
                <table class="w-full text-left text-sm text-gray-400">
                    <thead class="bg-gray-800 text-gray-200 uppercase font-bold">
                        <tr>
                            <th class="px-6 py-4">å°é¢</th>
                            <th class="px-6 py-4">æ ‡é¢˜</th>
                            <th class="px-6 py-4">ä»·æ ¼</th>
                            <th class="px-6 py-4">çŠ¶æ€</th>
                            <th class="px-6 py-4 text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="video-list-body" class="divide-y divide-gray-800">
                        <tr><td colspan="5" class="px-6 py-8 text-center">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3. è´¢åŠ¡ä¸­å¿ƒ (Finance) - ä¿®å¤é‡ç‚¹ -->
        <div id="tab-finance" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">è´¢åŠ¡ä¸­å¿ƒ</h2>
                <div class="flex gap-3">
                    <!-- å……å€¼æŒ‰é’® (ç»¿è‰²) -->
                    <button onclick="showRechargeModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold transition flex items-center">
                        <i class="fa-solid fa-plus-circle mr-2"></i>  å……å€¼
                    </button>
                    <!-- æç°æŒ‰é’® (çº¢è‰²ï¼Œæ–‡æ¡ˆå·²æ”¹ä¸ºâ€œæç°â€) -->
                    <button onclick="showWithdrawModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition flex items-center">
                        <i class="fa-solid fa-money-bill-transfer mr-2"></i>  æç°
                    </button>
                </div>
            </div>

            <!-- æµæ°´åˆ—è¡¨ -->
            <div class="bg-dark-card rounded-xl border border-gray-800 p-6">
                <h3 class="font-bold text-white mb-4 border-l-4 border-brand pl-3">è¿‘æœŸäº¤æ˜“è®°å½•</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-dark-bg rounded border border-gray-800">
                        <div>
                            <div class="text-white font-medium">æ–°äººæ³¨å†Œå¥–åŠ±</div>
                            <div class="text-xs text-gray-500">2024-05-20 12:00</div>
                        </div>
                        <div class="text-green-400 font-bold font-mono">+50.00</div>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-dark-bg rounded border border-gray-800">
                        <div>
                            <div class="text-white font-medium">ä¸Šä¼ è§†é¢‘å¥–åŠ±</div>
                            <div class="text-xs text-gray-500">2024-05-21 09:30</div>
                        </div>
                        <div class="text-green-400 font-bold font-mono">+10.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. è®¾ç½® (Settings) -->
        <div id="tab-settings" class="tab-content">
            <h2 class="text-2xl font-bold text-white mb-6">è´¦å·è®¾ç½®</h2>
            <div class="bg-dark-card rounded-xl border border-gray-800 p-8 max-w-xl">
                <div class="space-y-6">
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">ç”¨æˆ·å</label>
                        <input type="text" id="set-username" disabled class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 text-gray-500 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">ä¿®æ”¹å¯†ç </label>
                        <input type="password" placeholder="è¾“å…¥æ–°å¯†ç " class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-brand focus:outline-none">
                    </div>
                    <button class="w-full bg-brand hover:bg-brand-dark text-white py-3 rounded-lg font-bold transition">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. æ£€æŸ¥ç™»å½•
            const userStr = localStorage.getItem('currentUser');
            if(!userStr) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(userStr);

            // 2. å¡«å……åŸºç¡€ä¿¡æ¯
            document.getElementById('u-name').innerText = currentUser.username;
            document.getElementById('set-username').value = currentUser.username;
            
            // 3. è·å–æœ€æ–°ä½™é¢
            try {
                const res = await fetch(`/api/balance?username=${currentUser.username}`);
                const data = await res.json();
                document.getElementById('u-balance').innerText = data.balance.toLocaleString();
            } catch(e){}

            // 4. åŠ è½½è§†é¢‘åˆ—è¡¨
            loadMyVideos();

            // 5. å¼ºåˆ¶ç»‘å®šç‚¹å‡»äº‹ä»¶ (ä¿®å¤è·³è½¬é€»è¾‘)
            const balanceCard = document.getElementById('balance-card');
            if (balanceCard) {
                balanceCard.onclick = function() {
                    // æ¨¡æ‹Ÿç‚¹å‡»ä¾§è¾¹æ çš„â€œè´¢åŠ¡ä¸­å¿ƒâ€æŒ‰é’®ï¼Œè§¦å‘åˆ‡æ¢
                    const financeBtn = document.querySelector('[data-tab="finance"]');
                    if (financeBtn) financeBtn.click();
                };
            }
        });

        // åˆ‡æ¢ Tab é€»è¾‘
        function switchTab(tabName) {
            // 1. å¤„ç†å¯¼èˆªæ ·å¼
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-brand/10', 'text-brand');
                btn.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById(`btn-${tabName}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-400');
                activeBtn.classList.add('bg-brand/10', 'text-brand');
            }

            // 2. å¤„ç†å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) targetTab.classList.add('active');
        }

        // åŠ è½½æˆ‘çš„è§†é¢‘
        async function loadMyVideos() {
            try {
                // è¿™é‡Œç”¨å…¨é‡è§†é¢‘è¿‡æ»¤æ¨¡æ‹Ÿâ€œæˆ‘çš„è§†é¢‘â€ï¼Œå®é™…åº”è¯¥è°ƒç”¨åç«¯ä¸“å±æ¥å£
                const res = await fetch('/api/videos'); 
                const allVideos = await res.json();
                const myVideos = allVideos.filter(v => v.author === currentUser.username);
                
                document.getElementById('u-video-count').innerText = myVideos.length;

                const tbody = document.getElementById('video-list-body');
                tbody.innerHTML = '';

                if(myVideos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">æš‚æ— ä½œå“ï¼Œå¿«å»ä¸Šä¼ å§</td></tr>';
                    return;
                }

                myVideos.forEach(v => {
                    // çŠ¶æ€é€»è¾‘ï¼ˆå¦‚æœåç«¯æ²¡ä¼ statusï¼Œé»˜è®¤æ˜¾ç¤ºå·²å‘å¸ƒï¼‰
                    const statusBadge = (v.status === 'pending') 
                        ? '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded">å®¡æ ¸ä¸­</span>'
                        : '<span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">å·²å‘å¸ƒ</span>';

                    tbody.innerHTML += `
                        <tr class="hover:bg-white/5 transition">
                            <td class="px-6 py-4"><img src="${v.cover}" class="w-16 h-10 object-cover rounded bg-gray-700"></td>
                            <td class="px-6 py-4 font-bold text-white truncate max-w-xs">${v.title}</td>
                            <td class="px-6 py-4 text-yellow-400 font-mono">${v.price}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <button class="text-blue-400 hover:text-blue-300 text-xs">ç¼–è¾‘</button>
                                <button class="text-red-400 hover:text-red-300 text-xs">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // ç¡®ä¿ JS å‡½æ•°å­˜åœ¨ (ä¿®å¤è¦æ±‚ 3)
        window.showRechargeModal = function() {
            alert('å……å€¼åŠŸèƒ½å¼€å‘ä¸­');
        }

        window.showWithdrawModal = function() {
            alert('æç°åŠŸèƒ½å¼€å‘ä¸­');
        }
    </script>
</body>
</html>